<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apples to Apples ‚Äì Standalone (Local/CSV/JSON)</title>
  <style>
    :root {
      --bg: #0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#60a5fa; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
    }
    body {margin:0; font-family:system-ui,sans-serif; background:#0f172a; color:var(--text);}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#111827;color:white}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:8px 12px;font-weight:600;margin-left:6px}
    .btn.secondary{background:#334155;color:var(--text)}
    .btn.ghost{background:transparent;border:1px dashed #555;color:var(--text)}
    .btn.warn{background:var(--amber);color:#111827}
    .btn.danger{background:var(--red);color:white}
    .card{background:#111827;border:1px solid #333;border-radius:14px;padding:1rem;margin-top:1rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #333}
    th{background:#0b1220;text-align:left}
    tr:hover{background:#1e293b}
    .badge.lowest{background:var(--green);color:#111827;padding:2px 6px;border-radius:999px;font-size:12px}
    .hint{color:var(--muted);font-size:14px}
    select,input,textarea{background:#0b1220;color:var(--text);border:1px solid #444;border-radius:8px;padding:6px}
    .drop{border:2px dashed #555;border-radius:10px;padding:1rem;text-align:center;margin-top:1rem}
    .drop.drag{border-color:#93c5fd;background:rgba(147,197,253,.1)}
  </style>
</head>
<body>
  <div class="nav">
    <div>üçè Apples to Apples ‚Äì Standalone</div>
    <div>
      <button id="btnImport" class="btn">Import CSV/JSON</button>
      <button id="btnAddProject" class="btn secondary">New Project</button>
      <button id="btnAddQuote" class="btn secondary">Add Quote</button>
      <button id="btnExportCsv" class="btn ghost">Export CSV</button>
      <button id="btnSaveJson" class="btn ghost">Save JSON</button>
      <button id="btnClear" class="btn danger">Clear</button>
    </div>
  </div>

  <div class="card">
    <div class="hint">Drag & drop CSV or JSON here, or use the Import button.</div>
    <div id="drop" class="drop">Drop file here</div>
    <div style="margin-top:1rem">
      <label class="hint">Project:</label>
      <select id="projectSelect"></select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Vendor</th><th>Quote</th><th>Deposit</th><th>Timeline</th>
          <th>Status</th><th>Docs</th><th>Badge</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="quotesBody">
        <tr><td colspan="8" class="hint">No project selected</td></tr>
      </tbody>
    </table>
    <div id="status" class="hint">Ready.</div>
  </div>

  <input id="fileInput" type="file" accept=".csv,.json" style="display:none"/>

  <dialog id="dlgProject">
    <form method="dialog" style="padding:1rem;display:grid;gap:10px">
      <h3>New Project</h3>
      <input id="projName" placeholder="Project name" required>
      <input id="projDesc" placeholder="Description">
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" class="btn secondary">Cancel</button>
        <button id="projSave" value="default" class="btn">Save</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgQuote">
    <form method="dialog" style="padding:1rem;display:grid;gap:10px">
      <h3>Add Quote</h3>
      <input id="qVendor" placeholder="Vendor" required>
      <input id="qAmount" type="number" step="0.01" placeholder="Quote ($)" required>
      <input id="qDeposit" placeholder="Deposit">
      <input id="qTimeline" placeholder="Timeline">
      <input id="qStatus" placeholder="Status">
      <select id="qDocs"><option value="true">Docs Complete</option><option value="false" selected>Docs Incomplete</option></select>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" class="btn secondary">Cancel</button>
        <button id="quoteSave" value="default" class="btn">Save</button>
      </menu>
    </form>
  </dialog>

  <script>
    const KEY='a2a_data_v1'; let state=load();
    function load(){try{return JSON.parse(localStorage.getItem(KEY))||{projects:[],quotes:[]};}catch{return{projects:[],quotes:[]};}}
    function save(){localStorage.setItem(KEY,JSON.stringify(state));}
    function uid(){return Math.random().toString(36).slice(2,9);}
    const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
    function status(m){$('#status').textContent=m;}
    function money(v){if(v==null||v==='')return'‚Äî';const n=+v;return isNaN(n)?v:n.toLocaleString(undefined,{style:'currency',currency:'USD'});}
    function currentProject(){return state.projects.find(p=>p.id==$('#projectSelect').value);}
    function refreshProjects(selId){const s=$('#projectSelect');s.innerHTML='';state.projects.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;s.appendChild(o);});if(state.projects.length)s.value=selId||state.projects[0].id;}
    function projectQuotes(pid){return state.quotes.filter(q=>q.project_id==pid).sort((a,b)=>(a.amount??Infinity)-(b.amount??Infinity));}
    function renderQuotes(){const p=currentProject();const tb=$('#quotesBody');tb.innerHTML='';if(!p){tb.innerHTML='<tr><td colspan=8>No project</td></tr>';return;}const rows=projectQuotes(p.id);if(!rows.length){tb.innerHTML='<tr><td colspan=8>No quotes</td></tr>';return;}rows.forEach((q,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${q.vendor}</td><td>${money(q.amount)}</td><td>${q.deposit||'‚Äî'}</td><td>${q.timeline||'‚Äî'}</td><td>${q.status||'‚Äî'}</td><td>${q.documents_complete?'‚úÖ':'‚ùå'}</td><td>${i===0?'<span class=\"badge lowest\">Lowest</span>':''}${p.awarded_quote_id===q.id?'<span class=\"badge\" style=\"background:#93c5fd;color:#111827\">Awarded</span>':''}</td><td><button class=\"btn warn\" data-award=\"${q.id}\">Award</button><button class=\"btn secondary\" data-edit=\"${q.id}\">Edit</button><button class=\"btn danger\" data-del=\"${q.id}\">Del</button></td>`;tb.appendChild(tr);});$$('[data-award]').forEach(b=>b.onclick=()=>{p.awarded_quote_id=b.dataset.award;save();renderQuotes();status('Awarded.');});$$('[data-del]').forEach(b=>b.onclick=()=>{state.quotes=state.quotes.filter(x=>x.id!==b.dataset.del);save();renderQuotes();status('Deleted.');});$$('[data-edit]').forEach(b=>b.onclick=()=>editQuote(b.dataset.edit));}
    function editQuote(id){const q=state.quotes.find(x=>x.id===id);if(!q)return;$('#qVendor').value=q.vendor;$('#qAmount').value=q.amount;$('#qDeposit').value=q.deposit;$('#qTimeline').value=q.timeline;$('#qStatus').value=q.status;$('#qDocs').value=String(q.documents_complete);const d=$('#dlgQuote');d.showModal();$('#quoteSave').onclick=e=>{e.preventDefault();q.vendor=$('#qVendor').value;q.amount=+$('#qAmount').value;q.deposit=$('#qDeposit').value;q.timeline=$('#qTimeline').value;q.status=$('#qStatus').value;q.documents_complete=$('#qDocs').value==='true';save();d.close();renderQuotes();};}
    $('#btnAddProject').onclick=()=>{$('#projName').value='';$('#projDesc').value='';$('#dlgProject').showModal();};
    $('#projSave').onclick=e=>{e.preventDefault();const p={id:uid(),name:$('#projName').value,description:$('#projDesc').value,awarded_quote_id:null};state.projects.push(p);save();$('#dlgProject').close();refreshProjects(p.id);renderQuotes();};
    $('#btnAddQuote').onclick=()=>{if(!currentProject())return alert('Add a project first');$('#qVendor').value='';$('#qAmount').value='';$('#qDeposit').value='';$('#qTimeline').value='';$('#qStatus').value='';$('#qDocs').value='false';$('#dlgQuote').showModal();};
    $('#quoteSave').onclick=e=>{e.preventDefault();const p=currentProject();const q={id:uid(),project_id:p.id,vendor:$('#qVendor').value,amount:+$('#qAmount').value,deposit:$('#qDeposit').value,timeline:$('#qTimeline').value,status:$('#qStatus').value,documents_complete:$('#qDocs').value==='true'};state.quotes.push(q);save();$('#dlgQuote').close();renderQuotes();};
    $('#btnExportCsv').onclick=()=>{const p=currentProject();if(!p)return;const rows=[['Vendor','Quote','Deposit','Timeline','Status','Docs']];projectQuotes(p.id).forEach(q=>rows.push([q.vendor,q.amount,q.deposit,q.timeline,q.status,q.documents_complete]));const csv=rows.map(r=>r.join(',')).join('\\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=p.name+'_quotes.csv';a.click();};
    $('#btnSaveJson').onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));a.download='a2a_data.json';a.click();};
    $('#btnClear').onclick=()=>{if(confirm('Clear all local data?')){localStorage.removeItem(KEY);state=load();refreshProjects();renderQuotes();}};
    function parseCSV(txt){const l=txt.trim().split(/\\r?\\n/);const h=l[0].split(',').map(x=>x.trim().toLowerCase());const idx=k=>h.indexOf(k);const arr=[];for(let i=1;i<l.length;i++){const c=l[i].split(',');arr.push({project:c[idx('project')]||'General',vendor:c[idx('vendor')]||'',amount:+(c[idx('quote')]||0),deposit:c[idx('deposit')]||'',timeline:c[idx('timeline')]||'',status:c[idx('status')]||'',documents_complete:(c[idx('documents_complete')]||'').toLowerCase()==='true'});}return arr;}
    function importCSV(rows){rows.forEach(r=>{let p=state.projects.find(x=>x.name===r.project);if(!p){p={id:uid(),name:r.project,description:'',awarded_quote_id:null};state.projects.push(p);}state.quotes.push({id:uid(),project_id:p.id,vendor:r.vendor,amount:r.amount,deposit:r.deposit,timeline:r.timeline,status:r.status,documents_complete:r.documents_complete});});save();refreshProjects();renderQuotes();}
    function importJSON(obj){if(obj.projects&&obj.quotes){state=obj;save();refreshProjects();renderQuotes();}else if(Array.isArray(obj)){const name=prompt('Project name for imported quotes?')||'Imported';const p={id:uid(),name,description:'',awarded_quote_id:null};state.projects.push(p);obj.forEach(r=>state.quotes.push({id:uid(),project_id:p.id,vendor:r.vendor,amount:+r.amount,deposit:r.deposit,timeline:r.timeline,status:r.status,documents_complete:!!r.documents_complete}));save();refreshProjects(p.id);renderQuotes();}}
    $('#btnImport').onclick=()=>$('#fileInput').click();
    $('#fileInput').onchange=e=>handleFiles(e.target.files);
    function handleFiles(f){if(!f.length)return;const r=new FileReader();r.onload=()=>{try{if(f[0].name.endsWith('.json'))importJSON(JSON.parse(r.result));else importCSV(parseCSV(r.result));status('Imported.');}catch(err){alert('Import failed:'+err);}};r.readAsText(f[0]);}
    const drop=$('#drop');['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag');}));['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag');}));drop.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
    function boot(){refreshProjects();renderQuotes();}
    boot();
  </script>
</body>
</html>
