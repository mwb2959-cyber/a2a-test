<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apples-to-Apples</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Small helper styles (plain CSS) -->
  <style>
    .hud-card { background: rgba(255,255,255,.9); backdrop-filter: blur(6px); border-radius: 1rem; box-shadow: 0 8px 24px rgba(15,23,42,.08); border: 1px solid #e2e8f0; }
    .badge { display:inline-flex; align-items:center; font-size:12px; font-weight:600; padding:2px 8px; border-radius:9999px; border:1px solid transparent; }
    .badge-lowest  { background:#d1fae5; color:#065f46; border-color:#a7f3d0; }
    .badge-docs-ok { background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }
    .badge-missing { background:#ffe4e6; color:#be123c; border-color:#fecdd3; }
    .badge-awarded { background:#e0f2fe; color:#075985; border-color:#bae6fd; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:.75rem; padding:.5rem .75rem; border:1px solid #e2e8f0; background:#fff; color:#334155; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    .btn:hover { box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .btn-primary { background:#000; color:#fff; border-color:#000; }
    .btn-ghost { background:#fff; color:#334155; border-color:#e2e8f0; }
    .table { width:100%; font-size:14px; }
    .table th { text-align:left; font-weight:600; color:#475569; }
    .table tr { border-bottom:1px solid #f1f5f9; }
   .outlined-text {
  color: #dc2626; /* bright red */
  text-shadow: 
    -1px -1px 0 #fff,
     1px -1px 0 #fff,
    -1px  1px 0 #fff,
     1px  1px 0 #fff;
} 
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-green-700 backdrop-blur border-b border-slate-200">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <!-- LEFT: triple apples + title -->
    <div class="flex items-center gap-3">
      <div class="flex items-center">
  <!-- Left apple (slightly smaller) -->
  <div class="relative h-10 w-10 grid place-content-center">
    <span class="text-[28px] leading-none select-none">üçé</span>
  </div>

  <!-- Center apple with A2a overlay (larger + sits on top + glow) -->
  <div class="relative h-12 w-12 grid place-content-center -ml-3 z-10">
    <span class="text-[34px] leading-none select-none drop-shadow-[0_0_6px_rgba(255,255,255,0.8)]">
      üçè
    </span>
    <span
      class="absolute inset-0 grid place-content-center text-[16px] font-extrabold text-white"
      style="text-shadow:
        -2px -2px 0 #000,
         2px -2px 0 #000,
        -2px  2px 0 #000,
         2px  2px 0 #000;">
      A2a
    </span>
  </div>

  <!-- Right apple (slightly smaller, overlaps behind) -->
  <div class="relative h-10 w-10 grid place-content-center -ml-3">
    <span class="text-[28px] leading-none select-none">üçé</span>
  </div>
</div>
      
      <h1 class="text-xl font-bold outlined-text">Apples-to-Apples</h1>
    </div>

    <!-- RIGHT: buttons -->
    <nav class="flex items-center gap-2">
      <button id="btnExportCsv" class="btn btn-ghost" title="Export current view to CSV">
        <span class="i" data-icon="download"></span> Export CSV
      </button>
      <button id="btnEmailPurchasing" class="btn btn-ghost" title="Compose email to Purchasing">
        <span class="i" data-icon="mail"></span> Email Purchasing
      </button>
    </nav>
  </div>
</header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-4 grid md:grid-cols-12 gap-4">
    <!-- Controls -->
    <section class="md:col-span-12 hud-card p-4">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Project</span>
          <select id="selectProject" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-emerald-500">
            <option value="">Select a project‚Ä¶</option>
          </select>
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Search vendors</span>
          <input id="inputSearch" type="search" placeholder="Type to filter‚Ä¶" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-emerald-500" />
        </label>
        <div class="flex gap-2">
          <button id="btnRefresh" class="btn btn-ghost w-full"><span class="i" data-icon="refresh-ccw"></span> Refresh</button>
          <button id="btnNewQuote" class="btn btn-primary w-full"><span class="i" data-icon="plus"></span> New Quote</button>
        </div>
      </div>
    </section>

    <!-- Grid -->
    <section class="md:col-span-12 hud-card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table" id="grid">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3">Vendor</th>
              <th class="px-4 py-3">Quote</th>
              <th class="px-4 py-3">Deposit</th>
              <th class="px-4 py-3">Timeline</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Docs</th>
              <th class="px-4 py-3">Badges</th>
              <th class="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden p-8 text-center text-slate-500">Select a project to view quotes.</div>
    </section>
  </main>

  <!-- New Quote Modal -->
  <dialog id="dlgQuote" class="w-full max-w-xl rounded-2xl p-0 border border-slate-200 shadow-xl">
    <form method="dialog">
      <header class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="font-semibold">Add Quote</h3>
         <button class="btn btn-ghost" value="cancel"><span class="i" data-icon="x"></span></button>
      </header>
      <div class="p-4 grid md:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Vendor</span>
          <input id="qVendor" class="mt-1 w-full rounded-xl border-slate-300" required />
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Quote Total ($)</span>
          <input id="qTotal" type="number" step="0.01" class="mt-1 w-full rounded-xl border-slate-300" required />
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Deposit ($)</span>
          <input id="qDeposit" type="number" step="0.01" class="mt-1 w-full rounded-xl border-slate-300" />
        </label>
        <label class="block md:col-span-2">
          <span class="block text-xs font-medium text-slate-600">Timeline</span>
          <input id="qTimeline" placeholder="e.g., 2‚Äì3 weeks" class="mt-1 w-full rounded-xl border-slate-300" />
        </label>
        <label class="block md:col-span-2">
          <span class="block text-xs font-medium text-slate-600">Status</span>
          <select id="qStatus" class="mt-1 w-full rounded-xl border-slate-300">
            <option value="pending">Pending</option>
            <option value="review">Review</option>
            <option value="approved">Approved</option>
          </select>
        </label>
      </div>
      <footer class="flex justify-end gap-2 px-4 py-3 border-t">
        <button type="button" class="btn btn-ghost" onclick="dlgQuote.close()">Cancel</button>
        <button id="btnSaveQuote" class="btn btn-primary" value="default" type="submit">Save</button>
      </footer>
    </form>
  </dialog>

  <!-- App Script -->
  <script type="module">
    // =====================
    //  CONFIG
    // =====================
    const SUPABASE_URL = "https://bqwovrxpgrlbnczerzbm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxd292cnhwZ3JsYm5jemVyemJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDcyMDIsImV4cCI6MjA3MjA4MzIwMn0.rZW766TNcEjvc8h2Ilmo4jU0_TXbPzMGAg7wAZvRxD8";

    const TABLES = {
      PROJECT: "project",
      QUOTE:   "quotes",
      VIEW_RANKED: "apples_to_apples_rank",  // we'll try this first, then fall back to QUOTE
    };

    // =====================
    //  SUPABASE CLIENT
    // =====================
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =====================
    //  DOM
    // =====================
    const selectProject = document.getElementById('selectProject');
    const inputSearch   = document.getElementById('inputSearch');
    const btnRefresh    = document.getElementById('btnRefresh');
    const btnExportCsv  = document.getElementById('btnExportCsv');
    const btnEmailPurchasing = document.getElementById('btnEmailPurchasing');
    const btnNewQuote   = document.getElementById('btnNewQuote');
    const gridBody      = document.getElementById('gridBody');
    const emptyState    = document.getElementById('emptyState');

    const dlgQuote      = document.getElementById('dlgQuote');
    const qVendor       = document.getElementById('qVendor');
    const qTotal        = document.getElementById('qTotal');
    const qDeposit      = document.getElementById('qDeposit');
    const qTimeline     = document.getElementById('qTimeline');
    const qStatus       = document.getElementById('qStatus');
    const btnSaveQuote  = document.getElementById('btnSaveQuote');

    // =====================
    //  STATE
    // =====================
    let currentProjectId = null;
    let currentRows = [];
    let currentAwardedId = null; // which quote_id is awarded

    // =====================
    //  INIT
    // =====================
    document.addEventListener('DOMContentLoaded', async () => {
  hydrateIcons();
  await loadProjects();
  updateExportEnabled();   // keep Export button state correct on first load
});

    function hydrateIcons(){
      document.querySelectorAll('.i').forEach(el => {
        const name = el.getAttribute('data-icon');
        el.innerHTML = `<svg data-lucide="${name}" class="w-4 h-4"></svg>`;
      });
      try { lucide.createIcons(); } catch {}
    }

    async function loadProjects(){
    const { data, error } = await supabase.from(TABLES.PROJECT).select('*');

      if(error){ console.error(error); alert('Error loading projects'); return; }
      for (const p of data){
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.name || `Project ${p.id}`;
        selectProject.appendChild(opt);
      }
    }

    selectProject.addEventListener('change', async () => {
      currentProjectId = selectProject.value || null;
      await refreshGrid();
    });

    inputSearch.addEventListener('input', () => renderGrid());
    btnRefresh.addEventListener('click', () => refreshGrid());

    btnNewQuote.addEventListener('click', () => {
      if(!currentProjectId){ alert('Pick a project first.'); return; }
      qVendor.value = ""; qTotal.value = ""; qDeposit.value = ""; qTimeline.value = ""; qStatus.value = "pending";
      dlgQuote.showModal();
    });

    btnSaveQuote.addEventListener('click', async (e) => {
      e.preventDefault();
      const payload = {
        project_id: currentProjectId,
        vendor_name: qVendor.value.trim(),
        quote_total: Number(qTotal.value || 0),
        deposit: qDeposit.value === '' ? null : Number(qDeposit.value),
        timeline: qTimeline.value.trim() || null,
        status: qStatus.value,
      };
      const { error } = await supabase.from(TABLES.QUOTE).insert(payload);
      if(error){ console.error(error); alert('Error saving quote'); return; }
      dlgQuote.close();
      await refreshGrid();
    });
        // Allow ESC key to close the dialog (prevents required-field validation)
    dlgQuote.addEventListener('cancel', (e) => {
      e.preventDefault();
      dlgQuote.close();
    });

    // Allow clicking outside the white modal to close it
    dlgQuote.addEventListener('click', (e) => {
      const rect = dlgQuote.getBoundingClientRect();
      const insideDialog =
        e.clientX >= rect.left && e.clientX <= rect.right &&
        e.clientY >= rect.top && e.clientY <= rect.bottom;

      if (!insideDialog) dlgQuote.close();
    });

    btnExportCsv.addEventListener('click', () => exportCsv());
    btnEmailPurchasing.addEventListener('click', () => composeEmail());

    // =====================
    //  DATA HELPERS
    // =====================
    async function fetchRowsViaView(projectId){
      return await supabase
        .from(TABLES.VIEW_RANKED)
        .select('*')
        .eq('project_id', projectId)
        .order('quote_total', { ascending: true });
    }

    async function fetchRowsViaQuotes(projectId){
      return await supabase
        .from(TABLES.QUOTE)
        .select('id, project_id, vendor_name, quote_total, deposit, timeline, status')
        .eq('project_id', projectId)
        .order('quote_total', { ascending: true });
    }

    // =====================
    //  DATA / RENDER
    // =====================
    async function refreshGrid(){
      gridBody.innerHTML = '';
      if(!currentProjectId){ emptyState.classList.remove('hidden'); return; }
      emptyState.classList.add('hidden');

      // 1) Read awarded id for project
      const { data: proj, error: projErr } = await supabase
        .from(TABLES.PROJECT)
        .select('awarded_quote_id')
        .eq('id', currentProjectId)
        .single();
      if (projErr) { console.error(projErr); alert('Error loading project'); return; }
      currentAwardedId = proj?.awarded_quote_id || null;

      // 2) Try the VIEW first; if it errors or returns empty, fall back to QUOTES
      let data = null, error = null, used = 'view';

      ({ data, error } = await fetchRowsViaView(currentProjectId));
      if (error || !Array.isArray(data) || data.length === 0) {
        ({ data, error } = await fetchRowsViaQuotes(currentProjectId));
        used = 'quotes';
      }

      if(error){ console.error(error); alert('Error loading quotes'); return; }

      // 3) Normalize fields and compute lowest
      const lowest = data?.length ? Math.min(...data.map(r => Number((r.quote_total ?? Infinity)))) : null;

      currentRows = (data || []).map(r => {
        if (used === 'quotes') {
          return {
            quote_id: r.id,
            project_id: r.project_id,
            vendor_name: r.vendor_name,
            quote_total: r.quote_total,
            deposit: r.deposit,
            timeline: r.timeline,
            status: r.status,
            docs_ok: false, // not present in the table; default to false
            is_lowest: Number(r.quote_total) === lowest
          };
        }
        // used === 'view' (already has the right columns)
        return {
          ...r,
          is_lowest: typeof r.is_lowest === 'boolean' ? r.is_lowest : (Number(r.quote_total) === lowest)
        };
      });

      renderGrid();
    }

    function renderGrid(){
      const q = (inputSearch.value || '').toLowerCase();
      const rows = currentRows.filter(r => !q || (r.vendor_name||'').toLowerCase().includes(q));
      gridBody.innerHTML = rows.map(r => rowHtml(r)).join('');
      hydrateIcons();

      // Wire Award buttons ONLY if we haven't awarded yet
      if (!currentAwardedId) {
        rows.forEach(r => {
          const btn = document.getElementById(`award-${r.quote_id}`);
          if(btn){ btn.addEventListener('click', () => awardVendor(r)); }
        });
      }
    }

    function rowHtml(r){
      const money = (v) => v==null? '‚Äî' : `$${Number(v).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;

      const badges = [
        r.is_lowest ? `<span class="badge badge-lowest">Lowest</span>` : '',
        (currentAwardedId === r.quote_id) ? `<span class="badge badge-awarded">Awarded</span>` : ''
      ].filter(Boolean).join(' ');

      const actions = (currentAwardedId)
        ? ''
        : `<button id="award-${r.quote_id}" class="btn btn-primary"><span class="i" data-icon="trophy"></span> Award</button>`;

      return `
        <tr>
          <td class="px-4 py-3 font-medium">${escapeHtml(r.vendor_name||'')}</td>
          <td class="px-4 py-3">${money(r.quote_total)}</td>
          <td class="px-4 py-3">${money(r.deposit)}</td>
          <td class="px-4 py-3">${escapeHtml(r.timeline||'‚Äî')}</td>
          <td class="px-4 py-3">${escapeHtml(r.status||'‚Äî')}</td>
          <td class="px-4 py-3">
            ${r.docs_ok ? `<span class="badge badge-docs-ok">Docs ‚úÖ</span>` : `<span class="badge badge-missing">Missing ‚ùå</span>`}
          </td>
          <td class="px-4 py-3">${badges}</td>
          <td class="px-4 py-3 text-right">${actions}</td>
        </tr>`;
    }

    // =====================
    //  ACTIONS
    // =====================
    async function awardVendor(r){
      if(!confirm(`Award to ${r.vendor_name}?`)) return;
      const { error } = await supabase
        .from(TABLES.PROJECT)
        .update({ awarded_quote_id: r.quote_id })
        .eq('id', r.project_id);
      if(error){ console.error(error); alert('Error awarding vendor'); return; }
      currentAwardedId = r.quote_id;
      renderGrid();
      alert('Awarded!');
    }

    function exportCsv(){
  // Export only what's visible (respects the search filter)
  const q = (inputSearch.value || '').toLowerCase();
  const rows = currentRows.filter(r => !q || (r.vendor_name||'').toLowerCase().includes(q));

  if(!rows.length){
    alert('No rows to export for the current view.');
    return;
  }

  const headers = ['Vendor','Quote','Deposit','Timeline','Status','Docs','Lowest','Awarded'];
  const lines = [headers.join(',')];

  for(const r of rows){
    const line = [
      safeCsv(r.vendor_name),
      r.quote_total ?? '',
      r.deposit ?? '',
      safeCsv(r.timeline||''),
      safeCsv(r.status||''),
      r.docs_ok ? 'Yes' : 'No',
      r.is_lowest ? 'Yes' : 'No',
      (currentAwardedId === r.quote_id) ? 'Yes' : 'No'
    ].join(',');
    lines.push(line);
  }

  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = `apples-to-apples-${currentProjectId || 'no-project'}.csv`;
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
  URL.revokeObjectURL(url);
}

      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `apples-to-apples-${currentProjectId}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function composeEmail(){
      const subject = encodeURIComponent('Apples-to-Apples Comparison CSV');
      const body = encodeURIComponent('Hi Purchasing,\n\nAttached is the latest Apples-to-Apples comparison for the selected project.\n\nBest,\nMike');
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    // =====================
    //  UTILS
    // =====================
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    } 
    function updateExportEnabled(){
  const hasProject = !!currentProjectId;
  const q = (inputSearch.value || '').toLowerCase();
  const visibleCount = hasProject
    ? currentRows.filter(r => !q || (r.vendor_name||'').toLowerCase().includes(q)).length
    : 0;

  const enable = hasProject && visibleCount > 0;

  btnExportCsv.disabled = !enable;
  btnExportCsv.classList.toggle('opacity-50', !enable);
  btnExportCsv.classList.toggle('cursor-not-allowed', !enable);
}
    function safeCsv(s){
      const t = String(s||'');
      return (/[",\n]/.test(t)) ? '"'+t.replace(/"/g,'""')+'"' : t;
    }
  </script>
</body>
</html>
