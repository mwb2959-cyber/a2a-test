<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apples to Apples</title>
  <style>
    :root { --bg:#0a2540; --panel:#f1f5f9; --muted:#475569; --text:#0f172a; --accent:#60a5fa; --green:#22c55e; --amber:#f59e0b; --red:#ef4444; }
    body { margin:0; font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); }
    .nav{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:var(--panel);color:var(--text);font-weight:600}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:8px 12px;font-weight:600;margin-left:6px}
    .btn.secondary{background:#cbd5e1;color:var(--text)}
    .btn.ghost{background:transparent;border:1px dashed #64748b;color:var(--text)}
    .btn.warn{background:var(--amber);color:#111827}
    .btn.danger{background:var(--red);color:white}
    .card{background:var(--panel);border:1px solid #cbd5e1;border-radius:14px;padding:1rem;margin-top:1rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #cbd5e1}
    th{background:#e2e8f0;text-align:left}
    tr:hover{background:#f1f5f9}
    .badge.lowest{background:var(--green);color:#111827;padding:2px 6px;border-radius:999px;font-size:12px}
    .hint{color:var(--muted);font-size:14px}
    select,input,textarea{background:#e2e8f0;color:var(--text);border:1px solid #94a3b8;border-radius:8px;padding:6px}
    .drop{border:2px dashed #94a3b8;border-radius:10px;padding:1rem;text-align:center;margin-top:1rem}
    .drop.drag{border-color:#93c5fd;background:rgba(147,197,253,.2)}
  </style>
</head>
<body>
  <div class="nav">
    <div>üçè Apples to Apples</div>
    <div>
      <button id="btnImport" class="btn">Open File</button>
      <button id="btnAddProject" class="btn secondary">Add Project</button>
      <button id="btnAddQuote" class="btn secondary">Add Quote</button>
      <button id="btnExportCsv" class="btn ghost">Export</button>
      <button id="btnSaveJson" class="btn ghost">Save</button>
      <button id="btnClear" class="btn danger">Clear All</button>
    </div>
  </div>

  <div class="card">
    <div class="hint">Drag & drop a file here, or use the Open File button.</div>
    <div id="drop" class="drop">Drop file here</div>
    <div style="margin-top:1rem">
      <label class="hint">Project:</label>
      <select id="projectSelect"></select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Vendor</th><th>Quote</th><th>Deposit</th><th>Timeline</th>
          <th>Status</th><th>Docs</th><th>Badge</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="quotesBody">
        <tr><td colspan="8" class="hint">No project selected</td></tr>
      </tbody>
    </table>
    <div id="status" class="hint">Ready.</div>
  </div>

  <input id="fileInput" type="file" accept=".csv,.json" style="display:none"/>

  <!-- Add Project Dialog -->
  <dialog id="dlgProject">
    <form method="dialog" style="padding:1rem;display:grid;gap:10px">
      <h3>Add Project</h3>
      <input id="projName" placeholder="Project name">
      <input id="projDesc" placeholder="Description">
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button id="projCancel" type="button" class="btn secondary">Cancel</button>
        <button id="projSave" type="button" class="btn">Save</button>
      </menu>
    </form>
  </dialog>

  <!-- Add/Edit Quote Dialog -->
  <dialog id="dlgQuote">
    <form method="dialog" style="padding:1rem;display:grid;gap:10px">
      <h3>Add Quote</h3>
      <input id="qVendor" placeholder="Vendor">
      <input id="qAmount" type="number" step="0.01" placeholder="Quote ($)">
      <input id="qDeposit" placeholder="Deposit">
      <input id="qTimeline" placeholder="Timeline">
      <input id="qStatus" placeholder="Status">
      <select id="qDocs"><option value="true">Docs Complete</option><option value="false" selected>Docs Incomplete</option></select>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button id="quoteCancel" type="button" class="btn secondary">Cancel</button>
        <button id="quoteSave" type="button" class="btn">Save</button>
      </menu>
    </form>
  </dialog>

  <script>
    // ===== State =====
    const KEY='a2a_data_v1';
    let state = load();

    function load(){
      try { return JSON.parse(localStorage.getItem(KEY)) || {projects:[], quotes:[]}; }
      catch { return {projects:[], quotes:[]}; }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function uid(){ return Math.random().toString(36).slice(2,9); }

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function setStatus(m){ const el=document.getElementById('status'); if(el) el.textContent = m; }
    function money(v){ if(v==null||v==='') return '‚Äî'; const n=+v; return isNaN(n)? v : n.toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function currentProject(){ return state.projects.find(p => p.id === document.getElementById('projectSelect').value); }

    // ===== Projects / Quotes UI =====
    function refreshProjects(selId){
      const s = document.getElementById('projectSelect');
      s.innerHTML='';
      state.projects.forEach(p=>{
        const o=document.createElement('option');
        o.value=p.id; o.textContent=p.name; s.appendChild(o);
      });
      if(state.projects.length) s.value = selId || state.projects[0].id;
    }
    function projectQuotes(pid){
      return state.quotes
        .filter(q=> q.project_id === pid)
        .sort((a,b)=> (a.amount??Infinity) - (b.amount??Infinity));
    }

    function renderQuotes(){
      const p = currentProject();
      const tb = document.getElementById('quotesBody');
      tb.innerHTML='';
      if(!p){ tb.innerHTML = '<tr><td colspan=8 class="hint">No project selected</td></tr>'; return; }
      const rows = projectQuotes(p.id);
      if(!rows.length){ tb.innerHTML = '<tr><td colspan=8 class="hint">No quotes</td></tr>'; return; }
      rows.forEach((q,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${q.vendor||'‚Äî'}</td>
          <td>${money(q.amount)}</td>
          <td>${q.deposit||'‚Äî'}</td>
          <td>${q.timeline||'‚Äî'}</td>
          <td>${q.status||'‚Äî'}</td>
          <td>${q.documents_complete?'‚úÖ':'‚ùå'}</td>
          <td>${i===0?'<span class="badge lowest">Lowest</span>':''}${(p.awarded_quote_id===q.id)?' <span class="badge" style="background:#93c5fd;color:#111827">Awarded</span>':''}</td>
          <td>
            <button class="btn warn" data-award="${q.id}">Award</button>
            <button class="btn secondary" data-edit="${q.id}">Edit</button>
            <button class="btn danger" data-del="${q.id}">Del</button>
          </td>`;
        tb.appendChild(tr);
      });

      document.querySelectorAll('[data-award]').forEach(b=> b.onclick = () => { p.awarded_quote_id = b.dataset.award; save(); renderQuotes(); setStatus('Awarded.'); });
      document.querySelectorAll('[data-del]').forEach(b=> b.onclick = () => { state.quotes = state.quotes.filter(x=> x.id !== b.dataset.del); save(); renderQuotes(); setStatus('Deleted.'); });
      document.querySelectorAll('[data-edit]').forEach(b=> b.onclick = () => editQuote(b.dataset.edit));
    }

    function editQuote(id){
      const q = state.quotes.find(x=>x.id===id); if(!q) return;
      document.getElementById('qVendor').value = q.vendor||'';
      document.getElementById('qAmount').value = q.amount??'';
      document.getElementById('qDeposit').value = q.deposit||'';
      document.getElementById('qTimeline').value = q.timeline||'';
      document.getElementById('qStatus').value = q.status||'';
      document.getElementById('qDocs').value = String(!!q.documents_complete);
      const d = document.getElementById('dlgQuote');
      d.showModal();
      document.getElementById('quoteCancel').onclick = () => d.close();
      document.getElementById('quoteSave').onclick = (e) => {
        e.preventDefault();
        const vendor = document.getElementById('qVendor').value.trim();
        const amountRaw = document.getElementById('qAmount').value.trim();
        if(!vendor){ alert('Vendor is required.'); return; }
        if(amountRaw==='' || isNaN(Number(amountRaw))){ alert('Quote amount is required and must be a number.'); return; }
        q.vendor = vendor;
        q.amount = Number(amountRaw);
        q.deposit = document.getElementById('qDeposit').value.trim();
        q.timeline = document.getElementById('qTimeline').value.trim();
        q.status = document.getElementById('qStatus').value.trim();
        q.documents_complete = (document.getElementById('qDocs').value === 'true');
        save(); d.close(); renderQuotes(); setStatus('Quote updated.');
      };
    }

    // ===== Import / Export =====
    function csvEscape(v){
      const s = String(v ?? '');
      return (s.includes('"')||s.includes(',')||s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s;
    }
    function exportCSV(){
      const p = currentProject(); if(!p){ alert('Select a project first.'); return; }
      const list = projectQuotes(p.id); if(!list.length){ alert('No quotes to export for this project.'); return; }
      const rows = [[ 'Vendor','Quote','Deposit','Timeline','Status','Docs' ]];
      list.forEach(q=>{
        const amount = (q.amount!==undefined && q.amount!==null && q.amount!=='') ? q.amount : '';
        rows.push([ q.vendor||'', amount, q.deposit||'', q.timeline||'', q.status||'', q.documents_complete?'TRUE':'FALSE' ]);
      });
      const csv = rows.map(r => r.map(csvEscape).join(',')).join('\r\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download = (currentProject().name.replace(/\s+/g,'_')) + '_quotes.csv';
      a.click();
    }

    function parseCSV(txt){
      const l = txt.trim().split(/\r?\n/); if(!l.length) return [];
      const h = l[0].split(',').map(x=>x.trim().toLowerCase());
      const idx = k => h.indexOf(k);
      const arr = [];
      for(let i=1;i<l.length;i++){
        const c = l[i].split(',');
        arr.push({
          project: c[idx('project')]||'General',
          vendor:  c[idx('vendor')]||'',
          amount:  +(c[idx('quote')]||c[idx('amount')]||0),
          deposit: c[idx('deposit')]||'',
          timeline:c[idx('timeline')]||'',
          status:  c[idx('status')]||'',
          documents_complete: (c[idx('documents_complete')]||'').toLowerCase()==='true'
        });
      }
      return arr;
    }
    function importCSV(rows){
      rows.forEach(r=>{
        let p = state.projects.find(x=>x.name===r.project);
        if(!p){ p = {id:uid(), name:r.project, description:'Imported from CSV', awarded_quote_id:null}; state.projects.push(p); }
        state.quotes.push({ id:uid(), project_id:p.id, vendor:r.vendor, amount:r.amount, deposit:r.deposit, timeline:r.timeline, status:r.status, documents_complete: !!r.documents_complete });
      });
      save(); refreshProjects(); renderQuotes(); setStatus('CSV imported.');
    }
    function importJSON(obj){
      if(obj.projects && obj.quotes){ state=obj; save(); refreshProjects(); renderQuotes(); setStatus('JSON loaded.'); return; }
      if(Array.isArray(obj)){
        const name = prompt('Project name for imported quotes?') || 'Imported';
        const p = {id:uid(), name, description:'Imported JSON', awarded_quote_id:null};
        state.projects.push(p);
        obj.forEach(r=> state.quotes.push({ id:uid(), project_id:p.id, vendor:r.vendor||'', amount:+(r.amount||0), deposit:r.deposit||'', timeline:r.timeline||'', status:r.status||'', documents_complete: !!r.documents_complete }));
        save(); refreshProjects(p.id); renderQuotes(); setStatus('JSON quotes imported.');
      }
    }

    // ===== File + Drag & Drop =====
    document.getElementById('btnImport').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = (e) => handleFiles(e.target.files);
    function handleFiles(files){
      if(!files || !files.length) return;
      const f = files[0]; const reader = new FileReader();
      reader.onload = () => {
        try {
          if (f.name.toLowerCase().endsWith('.json')) importJSON(JSON.parse(reader.result));
          else importCSV(parseCSV(reader.result));
        } catch(err){ alert('Import failed: '+ err.message); }
      };
      reader.readAsText(f);
    }

    const drop = document.getElementById('drop');
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach	ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e=> handleFiles(e.dataTransfer.files));

    // ===== Project Dialog =====
    document.getElementById('btnAddProject').onclick = () => {
      document.getElementById('projName').value='';
      document.getElementById('projDesc').value='';
      const d = document.getElementById('dlgProject'); d.showModal();
      document.getElementById('projCancel').onclick = () => d.close();
      document.getElementById('projSave').onclick = () => {
        const name = document.getElementById('projName').value.trim();
        if(!name){ alert('Project name is required.'); return; }
        const p = { id:uid(), name, description:document.getElementById('projDesc').value.trim(), awarded_quote_id:null };
        state.projects.unshift(p); save(); d.close(); refreshProjects(p.id); renderQuotes(); setStatus('Project created.');
      };
    };

    // ===== Quote Dialog =====
    document.getElementById('btnAddQuote').onclick = () => {
      if(!currentProject()){ alert('Create or select a project first.'); return; }
      document.getElementById('qVendor').value='';
      document.getElementById('qAmount').value='';
      document.getElementById('qDeposit').value='';
      document.getElementById('qTimeline').value='';
      document.getElementById('qStatus').value='';
      document.getElementById('qDocs').value='false';
      const d = document.getElementById('dlgQuote'); d.showModal();
      document.getElementById('quoteCancel').onclick = () => d.close();
      document.getElementById('quoteSave').onclick = (e) => {
        e.preventDefault();
        const p = currentProject(); if(!p) return;
        const vendor = document.getElementById('qVendor').value.trim();
        const amountRaw = document.getElementById('qAmount').value.trim();
        if(!vendor){ alert('Vendor is required.'); return; }
        if(amountRaw==='' || isNaN(Number(amountRaw))){ alert('Quote amount is required and must be a number.'); return; }
        const q = { id:uid(), project_id:p.id, vendor, amount:Number(amountRaw), deposit:document.getElementById('qDeposit').value.trim(), timeline:document.getElementById('qTimeline').value.trim(), status:document.getElementById('qStatus').value.trim(), documents_complete: (document.getElementById('qDocs').value==='true') };
        state.quotes.push(q); save(); d.close(); renderQuotes(); setStatus('Quote added.');
      };
    };

    // ===== Export/Save/Clear =====
    document.getElementById('btnExportCsv').onclick = exportCSV;
    document.getElementById('btnSaveJson').onclick = () => {
      const a=document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
      a.download = 'a2a_data.json';
      a.click();
    };
    document.getElementById('btnClear').onclick = () => {
      if(confirm('This clears ALL projects and quotes saved in this browser. Continue?')){
        localStorage.removeItem(KEY);
        state = load();
        refreshProjects();
        renderQuotes();
        setStatus('All local data cleared.');
      }
    };

    // ===== Init =====
    (function boot(){ refreshProjects(); renderQuotes(); })();
  </script>
</body>
</html>
