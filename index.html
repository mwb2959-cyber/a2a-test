<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apples-to-Apples</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Tailwind utility styles using @apply -->
  <style type="text/tailwindcss">
    .hud-card { @apply bg-white/90 backdrop-blur rounded-2xl shadow-lg border border-slate-200; }
    .badge { @apply inline-flex items-center text-xs font-semibold px-2 py-1 rounded-full border; }
    .badge-lowest { @apply bg-emerald-100 text-emerald-700 border-emerald-200; }
    .badge-docs-ok { @apply bg-blue-100 text-blue-700 border-blue-200; }
    .badge-missing { @apply bg-rose-100 text-rose-700 border-rose-200; }
    .badge-awarded { @apply bg-sky-100 text-sky-800 border-sky-200; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-3 py-2 border shadow-sm hover:shadow-md transition; }
    .btn-primary { @apply bg-black text-white border-black; }
    .btn-ghost { @apply bg-white text-slate-700 border-slate-200; }
    .btn-danger { @apply bg-rose-600 text-white border-rose-600; }
    .table { @apply w-full text-sm; }
    .table th { @apply text-left font-semibold text-slate-600; }
    .table tr { @apply border-b border-slate-100; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-emerald-600 grid place-content-center text-white font-black">A²</div>
        <h1 class="text-xl font-bold">Apples-to-Apples</h1>
      </div>
      <nav class="flex items-center gap-2">
        <button id="btnExportCsv" class="btn btn-ghost" title="Export current view to CSV">
          <span class="i" data-icon="download"></span> Export CSV
        </button>
        <button id="btnEmailPurchasing" class="btn btn-ghost" title="Compose email to Purchasing with CSV attached (manual attach)">
          <span class="i" data-icon="mail"></span> Email Purchasing
        </button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-4 grid md:grid-cols-12 gap-4">
    <!-- Controls -->
    <section class="md:col-span-12 hud-card p-4">
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Project</span>
          <select id="selectProject" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-emerald-500">
            <option value="">Select a project…</option>
          </select>
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Search vendors</span>
          <input id="inputSearch" type="search" placeholder="Type to filter…" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-emerald-500" />
        </label>
        <div class="flex gap-2">
          <button id="btnRefresh" class="btn btn-ghost w-full"><span class="i" data-icon="refresh-ccw"></span> Refresh</button>
          <button id="btnNewQuote" class="btn btn-primary w-full"><span class="i" data-icon="plus"></span> New Quote</button>
        </div>
      </div>
    </section>

    <!-- Grid -->
    <section class="md:col-span-12 hud-card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table" id="grid">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3">Vendor</th>
              <th class="px-4 py-3">Quote</th>
              <th class="px-4 py-3">Deposit</th>
              <th class="px-4 py-3">Timeline</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Docs</th>
              <th class="px-4 py-3">Badges</th>
              <th class="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden p-8 text-center text-slate-500">Select a project to view quotes.</div>
    </section>
  </main>

  <!-- New Quote Modal -->
  <dialog id="dlgQuote" class="w-full max-w-xl rounded-2xl p-0 border border-slate-200 shadow-xl">
    <form method="dialog">
      <header class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="font-semibold">Add Quote</h3>
        <button class="btn btn-ghost" value="cancel"><span class="i" data-icon="x"></span></button>
      </header>
      <div class="p-4 grid md:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Vendor</span>
          <input id="qVendor" class="mt-1 w-full rounded-xl border-slate-300" required />
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Quote Total ($)</span>
          <input id="qTotal" type="number" step="0.01" class="mt-1 w-full rounded-xl border-slate-300" required />
        </label>
        <label class="block">
          <span class="block text-xs font-medium text-slate-600">Deposit ($)</span>
          <input id="qDeposit" type="number" step="0.01" class="mt-1 w-full rounded-xl border-slate-300" />
        </label>
        <label class="block md:col-span-2">
          <span class="block text-xs font-medium text-slate-600">Timeline</span>
          <input id="qTimeline" placeholder="e.g., 2–3 weeks" class="mt-1 w-full rounded-xl border-slate-300" />
        </label>
        <label class="block md:col-span-2">
          <span class="block text-xs font-medium text-slate-600">Status</span>
          <select id="qStatus" class="mt-1 w-full rounded-xl border-slate-300">
            <option value="pending">Pending</option>
            <option value="review">Review</option>
            <option value="approved">Approved</option>
          </select>
        </label>
      </div>
      <footer class="flex justify-end gap-2 px-4 py-3 border-t">
        <button class="btn btn-ghost" value="cancel">Cancel</button>
        <button id="btnSaveQuote" class="btn btn-primary" value="default" type="submit">Save</button>
      </footer>
    </form>
  </dialog>

  <!-- App Script -->
  <script type="module">
    // =====================
    //  CONFIG
    // =====================
    const SUPABASE_URL = "https://bqwovrxpgrlbnczerzbm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxd292cnhwZ3JsYm5jemVyemJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDcyMDIsImV4cCI6MjA3MjA4MzIwMn0.rZW766TNcEjvc8h2Ilmo4jU0_TXbPzMGAg7wAZvRxD8";

    const TABLES = {
      PROJECT: "Project",
      QUOTE: "Quote",
      VIEW_RANKED: "apples_to_apples_ranked",
    };
    // VIEW expects: quote_id, project_id, vendor_name, quote_total, deposit, timeline, status, docs_ok (bool), is_lowest (bool)

    // =====================
    //  SUPABASE CLIENT
    // =====================
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =====================
    //  DOM
    // =====================
    const selectProject = document.getElementById('selectProject');
    const inputSearch   = document.getElementById('inputSearch');
    const btnRefresh    = document.getElementById('btnRefresh');
    const btnExportCsv  = document.getElementById('btnExportCsv');
    const btnEmailPurchasing = document.getElementById('btnEmailPurchasing');
    const btnNewQuote   = document.getElementById('btnNewQuote');
    const gridBody      = document.getElementById('gridBody');
    const emptyState    = document.getElementById('emptyState');

    const dlgQuote      = document.getElementById('dlgQuote');
    const qVendor       = document.getElementById('qVendor');
    const qTotal        = document.getElementById('qTotal');
    const qDeposit      = document.getElementById('qDeposit');
    const qTimeline     = document.getElementById('qTimeline');
    const qStatus       = document.getElementById('qStatus');
    const btnSaveQuote  = document.getElementById('btnSaveQuote');

    // =====================
    //  STATE
    // =====================
    let currentProjectId = null;
    let currentRows = [];
    let currentAwardedId = null; // which quote_id is awarded

    // =====================
    //  INIT
    // =====================
    document.addEventListener('DOMContentLoaded', async () => {
      hydrateIcons();
      await loadProjects();
    });

    function hydrateIcons(){
      document.querySelectorAll('.i').forEach(el => {
        const name = el.getAttribute('data-icon');
        try { lucide.createIcons({ icons: { [name]: lucide[name] } }); } catch {}
        el.innerHTML = `<svg data-lucide="\${name}" class="w-4 h-4"></svg>`;
      });
      try { lucide.createIcons(); } catch {}
    }

    async function loadProjects(){
      const { data, error } = await supabase.from(TABLES.PROJECT).select('id,name').order('name');
      if(error){ console.error(error); alert('Error loading projects'); return; }
      for (const p of data){
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.name || `Project \${p.id}`;
        selectProject.appendChild(opt);
      }
    }

    selectProject.addEventListener('change', async () => {
      currentProjectId = selectProject.value || null;
      await refreshGrid();
    });

    inputSearch.addEventListener('input', () => renderGrid());
    btnRefresh.addEventListener('click', () => refreshGrid());

    btnNewQuote.addEventListener('click', () => {
      if(!currentProjectId){ alert('Pick a project first.'); return; }
      qVendor.value = ""; qTotal.value = ""; qDeposit.value = ""; qTimeline.value = ""; qStatus.value = "pending";
      dlgQuote.showModal();
    });

    btnSaveQuote.addEventListener('click', async (e) => {
      e.preventDefault();
      const payload = {
        project_id: currentProjectId,
        vendor_name: qVendor.value.trim(),
        quote_total: Number(qTotal.value || 0),
        deposit: qDeposit.value === '' ? null : Number(qDeposit.value),
        timeline: qTimeline.value.trim() || null,
        status: qStatus.value,
      };
      const { error } = await supabase.from(TABLES.QUOTE).insert(payload);
      if(error){ console.error(error); alert('Error saving quote'); return; }
      dlgQuote.close();
      await refreshGrid();
    });

    btnExportCsv.addEventListener('click', () => exportCsv());
    btnEmailPurchasing.addEventListener('click', () => composeEmail());

    // =====================
    //  DATA / RENDER
    // =====================
    async function refreshGrid(){
      gridBody.innerHTML = '';
      if(!currentProjectId){ emptyState.classList.remove('hidden'); return; }
      emptyState.classList.add('hidden');

      // 1) Read awarded id for project
      const { data: proj, error: projErr } = await supabase
        .from(TABLES.PROJECT)
        .select('awarded_quote_id')
        .eq('id', currentProjectId)
        .single();
      if (projErr) { console.error(projErr); alert('Error loading project'); return; }
      currentAwardedId = proj?.awarded_quote_id || null;

      // 2) Load quotes
      const { data, error } = await supabase
        .from(TABLES.VIEW_RANKED)
        .select('*')
        .eq('project_id', currentProjectId)
        .order('quote_total', { ascending: true });

      if(error){ console.error(error); alert('Error loading quotes'); return; }

      // 3) Ensure lowest flag if the view doesn’t provide it
      const lowest = data?.length ? Math.min(...data.map(r => Number(r.quote_total || Infinity))) : null;
      currentRows = (data || []).map(r => ({
        ...r,
        is_lowest: typeof r.is_lowest === 'boolean' ? r.is_lowest : (Number(r.quote_total) === lowest)
      }));

      renderGrid();
    }

    function renderGrid(){
      const q = (inputSearch.value || '').toLowerCase();
      const rows = currentRows.filter(r => !q || (r.vendor_name||'').toLowerCase().includes(q));
      gridBody.innerHTML = rows.map(r => rowHtml(r)).join('');
      hydrateIcons();

      // Wire Award buttons ONLY if we haven't awarded yet
      if (!currentAwardedId) {
        rows.forEach(r => {
          const btn = document.getElementById(`award-\${r.quote_id}`);
          if(btn){ btn.addEventListener('click', () => awardVendor(r)); }
        });
      }
    }

    function rowHtml(r){
      const money = (v) => v==null? '—' : `$\${Number(v).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;

      // badges
      const badges = [
        r.is_lowest ? `<span class="badge badge-lowest">Lowest</span>` : '',
        (currentAwardedId === r.quote_id) ? `<span class="badge badge-awarded">Awarded</span>` : ''
      ].filter(Boolean).join(' ');

      // actions: hide award once something is awarded
      const actions = (currentAwardedId)
        ? ''
        : `<button id="award-\${r.quote_id}" class="btn btn-primary"><span class="i" data-icon="trophy"></span> Award</button>`;

      return `
        <tr>
          <td class="px-4 py-3 font-medium">\${escapeHtml(r.vendor_name||'')}</td>
          <td class="px-4 py-3">\${money(r.quote_total)}</td>
          <td class="px-4 py-3">\${money(r.deposit)}</td>
          <td class="px-4 py-3">\${escapeHtml(r.timeline||'—')}</td>
          <td class="px-4 py-3">\${escapeHtml(r.status||'—')}</td>
          <td class="px-4 py-3">
            \${r.docs_ok ? `<span class="badge badge-docs-ok">Docs ✅</span>` : `<span class="badge badge-missing">Missing ❌</span>`}
          </td>
          <td class="px-4 py-3">\${badges}</td>
          <td class="px-4 py-3 text-right">\${actions}</td>
        </tr>`;
    }

    // =====================
    //  ACTIONS
    // =====================
    async function awardVendor(r){
      if(!confirm(\`Award to \${r.vendor_name}?\`)) return;
      const { error } = await supabase
        .from(TABLES.PROJECT)
        .update({ awarded_quote_id: r.quote_id })
        .eq('id', r.project_id);
      if(error){ console.error(error); alert('Error awarding vendor'); return; }
      currentAwardedId = r.quote_id;
      renderGrid();
      alert('Awarded!');
    }

    function exportCsv(){
      if(!currentRows.length){ alert('Nothing to export'); return; }
      const headers = ['Vendor','Quote','Deposit','Timeline','Status','Docs','Lowest','Awarded'];
      const lines = [headers.join(',')];
      for(const r of currentRows){
        const line = [
          safeCsv(r.vendor_name),
          r.quote_total ?? '',
          r.deposit ?? '',
          safeCsv(r.timeline||''),
          safeCsv(r.status||''),
          r.docs_ok? 'Yes':'No',
          r.is_lowest? 'Yes':'No',
          (currentAwardedId === r.quote_id)? 'Yes':'No'
        ].join(',');
        lines.push(line);
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = \`apples-to-apples-\${currentProjectId}.csv\`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function composeEmail(){
      const subject = encodeURIComponent('Apples-to-Apples Comparison CSV');
      const body = encodeURIComponent('Hi Purchasing,\n\nAttached is the latest Apples-to-Apples comparison for the selected project.\n\nBest,\nMike');
      window.location.href = \`mailto:?subject=\${subject}&body=\${body}\`;
    }

    // =====================
    //  UTILS
    // =====================
    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function safeCsv(s){
      const t = String(s||'');
      return (/[",\n]/.test(t)) ? '"'+t.replace(/"/g,'""')+'"' : t;
    }
  </script>
</body>
</html>
